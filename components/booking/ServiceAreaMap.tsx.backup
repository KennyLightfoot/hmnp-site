'use client';

import { useState, useEffect, useCallback } from 'react';
import { GoogleMap, LoadScript, Circle, Marker } from '@react-google-maps/api';
import { MapPin, AlertTriangle } from 'lucide-react';

interface ServiceAreaMapProps {
  serviceType: string;
  customerLocation: {
    street: string;
    city: string;
    state: string;
    zip: string;
    latitude?: number;
    longitude?: number;
  };
  onLocationUpdate: (location: any) => void;
}

const HOUSTON_ZIP_77591 = {
  lat: 29.5451,
  lng: -95.0803,
};

const SERVICE_AREAS = {
  'standard-notary': {
    radius: 15, // 15-mile radius per SOP
    color: '#3B82F6',
    name: 'Standard Notary'
  },
  'extended-hours-notary': {
    radius: 20, // 20-mile radius per SOP
    color: '#10B981',
    name: 'Extended Hours Notary'
  },
  'loan-signing-specialist': {
    radius: 30, // 30-mile radius per SOP
    color: '#8B5CF6',
    name: 'Loan Signing Specialist'
  },
  default: {
    radius: 15,
    color: '#6B7280',
    name: 'Service Area'
  }
};

const mapContainerStyle = {
  width: '100%',
  height: '300px',
};

const mapOptions = {
  disableDefaultUI: false,
  zoomControl: true,
  mapTypeControl: false,
  scaleControl: true,
  streetViewControl: false,
  rotateControl: false,
  fullscreenControl: false,
};

export default function ServiceAreaMap({
  serviceType,
  customerLocation,
  onLocationUpdate,
}: ServiceAreaMapProps) {
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [geocoder, setGeocoder] = useState<google.maps.Geocoder | null>(null);
  const [customerCoords, setCustomerCoords] = useState<{lat: number, lng: number} | null>(null);
  const [distance, setDistance] = useState<number>(0);
  const [isWithinServiceArea, setIsWithinServiceArea] = useState<boolean>(true);
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [error, setError] = useState<string>('');

  const serviceArea = SERVICE_AREAS[serviceType as keyof typeof SERVICE_AREAS] || SERVICE_AREAS.default;

  // Calculate distance between two coordinates using Haversine formula
  const calculateDistance = useCallback((lat1: number, lng1: number, lat2: number, lng2: number): number => {
    const R = 3959; // Earth's radius in miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = 
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }, []);

  // Geocode customer address
  const geocodeAddress = useCallback(async () => {
    if (!geocoder || !customerLocation.street || !customerLocation.city || !customerLocation.zip) {
      return;
    }

    setIsLoading(true);
    setError('');

    const address = `${customerLocation.street}, ${customerLocation.city}, ${customerLocation.state} ${customerLocation.zip}`;

    try {
      const response = await new Promise<google.maps.GeocoderResult[]>((resolve, reject) => {
        geocoder.geocode({ address }, (results, status) => {
          if (status === 'OK' && results) {
            resolve(results);
          } else {
            reject(new Error(`Geocoding failed: ${status}`));
          }
        });
      });

      if (response.length > 0) {
        const location = response[0].geometry.location;
        const coords = {
          lat: location.lat(),
          lng: location.lng(),
        };
        
        setCustomerCoords(coords);
        
        // Calculate distance from ZIP 77591
        const distanceFromBase = calculateDistance(
          HOUSTON_ZIP_77591.lat,
          HOUSTON_ZIP_77591.lng,
          coords.lat,
          coords.lng
        );
        
        setDistance(distanceFromBase);
        setIsWithinServiceArea(distanceFromBase <= serviceArea.radius);
        
        // Update parent component with location data
        onLocationUpdate({
          ...customerLocation,
          latitude: coords.lat,
          longitude: coords.lng,
        });
        
        // Center map on customer location
        if (map) {
          map.panTo(coords);
          map.setZoom(12);
        }
      }
    } catch (err) {
      setError('Unable to find address. Please verify the address is correct.');
      console.error('Geocoding error:', err);
    } finally {
      setIsLoading(false);
    }
  }, [geocoder, customerLocation, serviceArea.radius, calculateDistance, onLocationUpdate, map]);

  // Initialize geocoder when map loads
  const onLoad = useCallback((map: google.maps.Map) => {
    setMap(map);
    setGeocoder(new google.maps.Geocoder());
  }, []);

  // Geocode address when location changes
  useEffect(() => {
    if (geocoder && customerLocation.street && customerLocation.city && customerLocation.zip) {
      const timeoutId = setTimeout(geocodeAddress, 500); // Debounce
      return () => clearTimeout(timeoutId);
    }
  }, [geocodeAddress, geocoder, customerLocation]);

  return (
    <div className="space-y-4">
      {/* Service Area Info */}
      <div className="bg-blue-50 rounded-lg p-4">
        <h4 className="font-semibold text-blue-900 mb-2">
          {serviceArea.name} Service Area
        </h4>
        <p className="text-sm text-blue-700">
          {serviceArea.radius}-mile radius from ZIP 77591 (Pasadena, TX)
        </p>
        {distance > 0 && (
          <div className="mt-2 text-sm">
            <span className="text-blue-700">Your location: </span>
            <span className={`font-medium ${isWithinServiceArea ? 'text-green-600' : 'text-orange-600'}`}>
              {distance.toFixed(1)} miles from base
            </span>
          </div>
        )}
      </div>

      {/* Warning for out-of-area locations */}
      {distance > 0 && !isWithinServiceArea && (
        <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
          <div className="flex items-start">
            <AlertTriangle className="h-5 w-5 text-orange-500 mt-0.5 mr-2 flex-shrink-0" />
            <div>
              <h4 className="font-medium text-orange-800">Outside Standard Service Area</h4>
              <p className="text-sm text-orange-700 mt-1">
                Your location is {distance.toFixed(1)} miles from our base in ZIP 77591, which is beyond our 
                standard {serviceArea.radius}-mile service radius. Additional travel fees will apply at $0.50 per mile 
                beyond the service area.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Error Message */}
      {error && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <p className="text-sm text-red-700">{error}</p>
        </div>
      )}

      {/* Loading State */}
      {isLoading && (
        <div className="bg-gray-50 rounded-lg p-4">
          <div className="flex items-center">
            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-2"></div>
            <span className="text-sm text-gray-600">Locating address...</span>
          </div>
        </div>
      )}

      {/* Google Map */}
      <div className="rounded-lg overflow-hidden border border-gray-200">
        <LoadScript
          googleMapsApiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || ''}
          libraries={['places']}
        >
          <GoogleMap
            mapContainerStyle={mapContainerStyle}
            center={customerCoords || HOUSTON_ZIP_77591}
            zoom={customerCoords ? 12 : 10}
            options={mapOptions}
            onLoad={onLoad}
          >
            {/* Service Area Circle */}
            <Circle
              center={HOUSTON_ZIP_77591}
              radius={serviceArea.radius * 1609.34} // Convert miles to meters
              options={{
                strokeColor: serviceArea.color,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: serviceArea.color,
                fillOpacity: 0.1,
              }}
            />

            {/* Base Location Marker */}
            <Marker
              position={HOUSTON_ZIP_77591}
              title="Houston Mobile Notary Pros - Base Location (ZIP 77591)"
              icon={{
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                  <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="12" fill="${serviceArea.color}" stroke="white" stroke-width="2"/>
                    <circle cx="16" cy="16" r="4" fill="white"/>
                  </svg>
                `),
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 16),
              }}
            />

            {/* Customer Location Marker */}
            {customerCoords && (
              <Marker
                position={customerCoords}
                title="Your Location"
                icon={{
                  url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="32" height="40" viewBox="0 0 32 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M16 0C7.163 0 0 7.163 0 16c0 16 16 24 16 24s16-8 16-24c0-8.837-7.163-16-16-16z" fill="${isWithinServiceArea ? '#10B981' : '#F59E0B'}"/>
                      <circle cx="16" cy="16" r="6" fill="white"/>
                    </svg>
                  `),
                  scaledSize: new google.maps.Size(32, 40),
                  anchor: new google.maps.Point(16, 40),
                }}
              />
            )}
          </GoogleMap>
        </LoadScript>
      </div>

      {/* Map Legend */}
      <div className="bg-gray-50 rounded-lg p-4">
        <h4 className="font-medium text-gray-900 mb-2">Map Legend</h4>
        <div className="space-y-2 text-sm">
          <div className="flex items-center">
            <div className={`w-4 h-4 rounded-full mr-2`} style={{ backgroundColor: serviceArea.color }}></div>
            <span>Service area center (ZIP 77591)</span>
          </div>
          <div className="flex items-center">
            <div className={`w-4 h-4 mr-2`}>
              <svg viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 0C3.582 0 0 3.582 0 8c0 8 8 12 8 12s8-4 8-12c0-4.418-3.582-8-8-8z" fill="#10B981"/>
              </svg>
            </div>
            <span>Your location (within service area)</span>
          </div>
          <div className="flex items-center">
            <div className={`w-4 h-4 mr-2`}>
              <svg viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 0C3.582 0 0 3.582 0 8c0 8 8 12 8 12s8-4 8-12c0-4.418-3.582-8-8-8z" fill="#F59E0B"/>
              </svg>
            </div>
            <span>Your location (outside service area)</span>
          </div>
        </div>
      </div>
    </div>
  );
}