
// Authentication Schema for Houston Mobile Notary Pros API

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String    @map("password_hash")
  firstName      String    @map("first_name")
  lastName       String?   @map("last_name")
  phoneNumber    String?   @map("phone_number")
  isActive       Boolean   @default(true) @map("is_active")
  lastLoginAt    DateTime? @map("last_login_at")
  profileImageUrl String?   @map("profile_image_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  
  // Relations
  roles          UserRole[]
  refreshTokens  RefreshToken[]
  loginAttempts  LoginAttempt[]
  
  @@map("api_users")
}

// Role model for authorization
model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  permissions Json?      // Stores an array of permission strings
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  
  // Relations
  users       UserRole[]
  
  @@map("api_roles")
}

// UserRole junction table
model UserRole {
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@id([userId, roleId])
  @@map("api_user_roles")
}

// RefreshToken for JWT authentication
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_refresh_tokens")
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// LoginAttempt for tracking authentication attempts
model LoginAttempt {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  success   Boolean  @default(false)
  ipAddress String   @map("ip_address")
  userAgent String?  @map("user_agent")
  timestamp DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_login_attempts")
  @@index([userId])
  @@index([timestamp])
  @@index([ipAddress])
}

// API Keys for system-to-system integration
model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  permissions Json?     // Array of permission strings
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  description String?
  
  @@map("api_keys")
  @@index([key])
  @@index([active])
}
    