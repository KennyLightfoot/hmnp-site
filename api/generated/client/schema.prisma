// Houston Mobile Notary API - Prisma Schema
// This extends your existing schema for the API workflow system

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// Booking model for API workflow system
model ApiBooking {
  id        String @id @default(cuid())
  bookingId String @unique @map("booking_id") // HMNP-XXX format

  // Customer information
  ghlContactId  String @map("ghl_contact_id")
  customerName  String @map("customer_name")
  customerEmail String @map("customer_email")
  customerPhone String @map("customer_phone")

  // Service details
  serviceName        String  @map("service_name")
  serviceDescription String? @map("service_description")
  servicePrice       Decimal @map("service_price") @db.Decimal(10, 2)

  // Scheduling
  scheduledDateTime DateTime @map("scheduled_date_time")
  duration          Int      @default(30) // minutes
  timezone          String   @default("America/Chicago")
  appointmentStatus String   @default("scheduled") @map("appointment_status") // scheduled, confirmed, in_progress, completed, cancelled, no_show, rescheduled

  // Location
  locationType     String  @map("location_type") // CLIENT_SPECIFIED_ADDRESS, BUSINESS_LOCATION, MEETING_POINT
  addressStreet    String? @map("address_street")
  addressCity      String? @default("Houston") @map("address_city")
  addressState     String? @default("TX") @map("address_state")
  addressZip       String? @map("address_zip")
  addressFormatted String? @map("address_formatted")
  locationNotes    String? @map("location_notes")

  // Payment information
  paymentAmount    Decimal   @map("payment_amount") @db.Decimal(10, 2)
  paymentStatus    String    @default("pending") @map("payment_status") // pending, completed, failed, expired, refunded
  paymentMethod    String    @default("stripe") @map("payment_method") // stripe, cash, check, other
  paymentUrl       String?   @map("payment_url")
  paymentIntentId  String?   @map("payment_intent_id") // Stripe payment intent ID
  paidAt           DateTime? @map("paid_at")
  paymentExpiresAt DateTime  @map("payment_expires_at")

  // Payment intelligence fields
  urgencyLevel   String    @default("new") @map("urgency_level") // new, medium, high, critical
  hoursOld       Int       @default(0) @map("hours_old")
  remindersSent  Int       @default(0) @map("reminders_sent")
  lastReminderAt DateTime? @map("last_reminder_at")

  // Lead source and tracking
  leadSource    String  @map("lead_source") // Website_Booking, Phone_Call, Contact_Form, etc.
  campaignName  String? @map("campaign_name")
  referralCode  String? @map("referral_code")
  ghlWorkflowId String? @map("ghl_workflow_id")
  triggerSource String? @map("trigger_source")

  // Additional data
  notes         String? @map("notes")
  internalNotes String? @map("internal_notes")

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String   @default("system") @map("created_by")

  // Relations
  paymentActions   ApiPaymentAction[]
  workflowTriggers ApiWorkflowTrigger[]
  documents        ApiBookingDocument[]

  @@index([ghlContactId])
  @@index([paymentStatus])
  @@index([urgencyLevel])
  @@index([scheduledDateTime])
  @@index([leadSource])
  @@index([createdAt])
  @@map("api_bookings")
}

// Payment action tracking
model ApiPaymentAction {
  id           String   @id @default(cuid())
  bookingId    String   @map("booking_id")
  actionType   String   @map("action_type") // send_reminder, mark_contacted, mark_expired, payment_completed
  reminderType String?  @map("reminder_type") // email, sms, call
  notes        String?
  timestamp    DateTime @default(now())

  // Relations
  booking ApiBooking @relation(fields: [bookingId], references: [bookingId], onDelete: Cascade)

  @@index([bookingId])
  @@index([actionType])
  @@index([timestamp])
  @@map("api_payment_actions")
}

// Workflow trigger tracking
model ApiWorkflowTrigger {
  id           String    @id @default(cuid())
  bookingId    String    @map("booking_id")
  workflowName String    @map("workflow_name")
  status       String    @default("pending") // pending, in_progress, completed, failed
  triggeredAt  DateTime  @default(now()) @map("triggered_at")
  completedAt  DateTime? @map("completed_at")
  errorMessage String?   @map("error_message")

  // Relations
  booking ApiBooking @relation(fields: [bookingId], references: [bookingId], onDelete: Cascade)

  @@index([bookingId])
  @@index([workflowName])
  @@index([status])
  @@index([triggeredAt])
  @@map("api_workflow_triggers")
}

// Document tracking
model ApiBookingDocument {
  id        String @id @default(cuid())
  bookingId String @map("booking_id")
  name      String
  type      String
  count     Int    @default(1)

  // Relations
  booking ApiBooking @relation(fields: [bookingId], references: [bookingId], onDelete: Cascade)

  @@index([bookingId])
  @@map("api_booking_documents")
}

// Business intelligence tracking
model ApiBusinessMetrics {
  id   String   @id @default(cuid())
  date DateTime @unique @default(now()) @db.Date

  // Daily metrics
  totalBookings       Int     @default(0) @map("total_bookings")
  pendingPayments     Int     @default(0) @map("pending_payments")
  completedPayments   Int     @default(0) @map("completed_payments")
  failedPayments      Int     @default(0) @map("failed_payments")
  totalRevenue        Decimal @default(0) @map("total_revenue") @db.Decimal(10, 2)
  averageBookingValue Decimal @default(0) @map("average_booking_value") @db.Decimal(10, 2)

  // Urgency breakdown
  urgencyNew      Int @default(0) @map("urgency_new")
  urgencyMedium   Int @default(0) @map("urgency_medium")
  urgencyHigh     Int @default(0) @map("urgency_high")
  urgencyCritical Int @default(0) @map("urgency_critical")

  // Lead sources
  websiteBookings  Int @default(0) @map("website_bookings")
  phoneBookings    Int @default(0) @map("phone_bookings")
  formBookings     Int @default(0) @map("form_bookings")
  referralBookings Int @default(0) @map("referral_bookings")
  adBookings       Int @default(0) @map("ad_bookings")

  @@index([date])
  @@map("api_business_metrics")
}

// API request logging
model ApiRequestLog {
  id         String   @id @default(cuid())
  method     String
  url        String
  statusCode Int      @map("status_code")
  duration   Int // milliseconds
  ip         String?
  userAgent  String?  @map("user_agent")
  timestamp  DateTime @default(now())

  // Request details
  requestSize  Int?    @map("request_size")
  responseSize Int?    @map("response_size")
  errorMessage String? @map("error_message")

  @@index([method, url])
  @@index([statusCode])
  @@index([timestamp])
  @@index([ip])
  @@map("api_request_logs")
}
