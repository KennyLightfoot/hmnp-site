generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Service {
  id                 String      @id @default(cuid())
  name               String      @unique
  description        String?
  serviceType        ServiceType
  durationMinutes    Int
  basePrice          Decimal     @db.Decimal(10, 2)
  isActive           Boolean     @default(true)
  requiresDeposit    Boolean     @default(true)
  depositAmount      Decimal     @default(25.00) @db.Decimal(10, 2)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  externalCalendarId String?     @unique
  bookings           Booking[]

  @@index([isActive])
  @@index([serviceType])
}

model Booking {
  id                          String                 @id @default(cuid())
  signerId                    String?
  serviceId                   String
  notaryId                    String?
  scheduledDateTime           DateTime?
  actualEndDateTime           DateTime?
  status                      BookingStatus          @default(REQUESTED)
  locationType                LocationType?
  addressStreet               String?
  addressCity                 String?
  addressState                String?
  addressZip                  String?
  locationNotes               String?
  priceAtBooking              Decimal                @db.Decimal(10, 2)
  notes                       String?
  dailyRoomUrl                String?
  dailyRecordingId            String?
  kbaStatus                   String?
  idVerificationStatus        String?
  notaryJournalEntry          String?
  createdAt                   DateTime               @default(now())
  updatedAt                   DateTime               @updatedAt
  confirmationEmailSentAt     DateTime?
  confirmationSmsSentAt       DateTime?
  followUpSentAt              DateTime?
  lastReminderSentAt          DateTime?
  noShowCheckPerformedAt      DateTime?
  reminder1hrSentAt           DateTime?
  reminder24hrSentAt          DateTime?
  reminder2hrSentAt           DateTime?
  depositAmount               Decimal?               @db.Decimal(10, 2)
  depositStatus               PaymentStatus?         @default(PENDING)
  googleCalendarEventId       String?                @unique
  promoCodeDiscount           Decimal?               @db.Decimal(10, 2)
  promoCodeId                 String?
  campaignName                String?
  customerEmail               String?
  customerName                String?
  ghlContactId                String?
  leadSource                  String?
  stripePaymentUrl            String?
  workflowId                  String?
  witness_type                witness_source?
  witness_fee                 Decimal?               @default(0) @db.Decimal(5, 2)
  mileage_miles               Decimal?               @db.Decimal(5, 2)
  mileage_fee                 Decimal?               @default(0) @db.Decimal(5, 2)
  urgency_level               String?                @default("standard") @db.VarChar(20)
  urgency_fee                 Decimal?               @default(0) @db.Decimal(5, 2)
  estimated_completion_time   DateTime?              @db.Timestamptz(6)
  notary_travel_time_minutes  Int?
  google_maps_distance_matrix Json?
  service_area_id             String?
  calculatedDistance          Float?                 @db.Real
  distanceCalculationMeta     Json?
  pricingBreakdown            Json?
  pricingVersion              String?                @default("2.0.0") @db.VarChar(10)
  serviceAreaValidated        Boolean?               @default(false)
  travelFee                   Decimal?               @default(0.00) @db.Decimal(10, 2)
  User_Booking_notaryIdToUser User?                  @relation("Booking_notaryIdToUser", fields: [notaryId], references: [id])
  promoCode                   PromoCode?             @relation(fields: [promoCodeId], references: [id])
  service                     Service                @relation(fields: [serviceId], references: [id])
  service_areas               service_areas?         @relation(fields: [service_area_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User_Booking_signerIdToUser User?                  @relation("Booking_signerIdToUser", fields: [signerId], references: [id])
  NotarizationDocument        NotarizationDocument[]
  uploadedDocuments           BookingUploadedDocument[]
  dispatchAssignments         DispatchAssignment[]
  qaRecord                    BookingQARecord?
  NotificationLog             NotificationLog[]
  payments                    Payment[]
  PricingAuditLog             PricingAuditLog[]
  supportTickets              SupportTicket[]
  notary_journal              notary_journal[]
  reviews                     Review[]
  contractorPayoutEntries     ContractorPayoutEntry[]
  auditLogs                   AuditLog[]
  jobOffers                   JobOffer[]
  stripeSessionId             String?                @unique // AC-5
  proofSessionUrl             String?                @db.Text
  // Payment lifecycle (booking-level)
  paymentMethod               PaymentMethod          @default(PAY_ON_SITE)
  paymentStatus               PaymentStatus          @default(PENDING)
  totalPaid                   Decimal?               @default(0) @db.Decimal(10, 2)
  paidAt                      DateTime?
  paidMarkedByUserId          String?
  paidNotes                   String?
  // Network distribution fields
  sendToNetwork               Boolean?                 @default(false)
  networkOfferExpiresAt       DateTime?

  @@index([scheduledDateTime])
  @@index([status])
  @@index([depositStatus])
  @@index([paymentStatus])
  @@index([paidAt])
  @@index([lastReminderSentAt])
  @@index([locationType])
  @@index([noShowCheckPerformedAt])
  @@index([notaryId])
  @@index([priceAtBooking])
  @@index([promoCodeId])
  @@index([serviceId])
  @@index([signerId])
  @@index([calculatedDistance], map: "idx_booking_calculated_distance")
  @@index([pricingVersion], map: "idx_booking_pricing_version")
  @@index([service_area_id], map: "idx_booking_service_area")
  @@index([serviceAreaValidated], map: "idx_booking_service_area_validated")
  @@index([travelFee], map: "idx_booking_travel_fee")
  @@index([urgency_level], map: "idx_booking_urgency")
  @@index([witness_type], map: "idx_booking_witness_type")
  @@index([sendToNetwork], map: "idx_booking_send_to_network")
  @@index([networkOfferExpiresAt], map: "idx_booking_network_offer_expires")
}

model BookingUploadedDocument {
  id         String   @id @default(cuid())
  bookingId  String
  s3Key      String
  filename   String
  contentType String?
  sizeBytes  Int?
  uploadedAt DateTime @default(now())

  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

model BookingQARecord {
  id                          String    @id @default(cuid())
  bookingId                   String    @unique
  qaUserId                    String?
  status                      QAStatus  @default(PENDING)
  journalEntryVerified        Boolean   @default(false)
  sealPhotoVerified           Boolean   @default(false)
  documentCountVerified       Boolean   @default(false)
  clientConfirmationVerified  Boolean   @default(false)
  closeoutFormVerified        Boolean   @default(false)
  notes                       String?
  followUpAction              String?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt

  booking                     Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  qaUser                      User?     @relation(fields: [qaUserId], references: [id])

  @@index([qaUserId])
}

model Payment {
  id              String          @id @default(cuid())
  bookingId       String
  amount          Decimal         @db.Decimal(10, 2)
  status          PaymentStatus   @default(PENDING)
  provider        PaymentProvider
  transactionId   String?         @unique
  paymentIntentId String?         @unique
  notes           String?
  paidAt          DateTime?
  refundedAmount  Decimal?        @db.Decimal(10, 2)
  refundedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  booking         Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([paymentIntentId])
  @@index([provider])
}

model ContractorPayout {
  id           String                 @id @default(cuid())
  notaryId     String
  periodStart  DateTime
  periodEnd    DateTime
  status       ContractorPayoutStatus @default(PENDING)
  totalAmount  Decimal                @default(0) @db.Decimal(10, 2)
  generatedAt  DateTime?              @default(now())
  finalizedAt  DateTime?
  notes        String?
  entries      ContractorPayoutEntry[]

  notary       User                   @relation(fields: [notaryId], references: [id])

  @@index([notaryId, periodStart, periodEnd])
  @@unique([notaryId, periodStart, periodEnd])
}

model ContractorPayoutEntry {
  id          String                      @id @default(cuid())
  payoutId    String
  bookingId   String?
  entryType   ContractorPayoutEntryType
  description String?
  amount      Decimal                     @db.Decimal(10, 2)
  metadata    Json?
  createdAt   DateTime                    @default(now())

  payout      ContractorPayout            @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  booking     Booking?                    @relation(fields: [bookingId], references: [id])

  @@index([payoutId])
  @@index([bookingId])
}

model SupportTicket {
  id                   String                   @id @default(cuid())
  bookingId            String?
  customerEmail        String
  customerName         String
  issueType            SupportIssueType
  priority             SupportPriority          @default(medium)
  description          String
  status               SupportStatus            @default(open)
  assignedTo           String?
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  resolvedAt           DateTime?
  customerSatisfaction Int?
  tags                 String[]                 @default([])
  metadata             Json?
  history              CustomerSupportHistory[]
  responses            SupportResponse[]
  booking              Booking?                 @relation(fields: [bookingId], references: [id])

  @@index([customerEmail])
  @@index([bookingId])
  @@index([status])
  @@index([priority])
  @@index([issueType])
  @@index([assignedTo])
}

model SupportResponse {
  id               String        @id @default(cuid())
  ticketId         String
  message          String
  isAutomated      Boolean       @default(false)
  responseTime     Int
  nextSteps        String[]
  escalationNeeded Boolean       @default(false)
  createdAt        DateTime      @default(now())
  createdBy        String?
  metadata         Json?
  ticket           SupportTicket @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
}

model CustomerSupportHistory {
  id              String        @id @default(cuid())
  customerEmail   String
  ticketId        String
  interactionType String
  description     String
  createdAt       DateTime      @default(now())
  metadata        Json?
  ticket          SupportTicket @relation(fields: [ticketId], references: [id])

  @@index([customerEmail])
  @@index([ticketId])
}

model PromoCode {
  id                 String       @id @default(cuid())
  code               String       @unique
  description        String?
  discountType       DiscountType @default(PERCENTAGE)
  discountValue      Decimal      @db.Decimal(10, 2)
  minimumAmount      Decimal?     @db.Decimal(10, 2)
  maxDiscountAmount  Decimal?     @db.Decimal(10, 2)
  usageLimit         Int?
  usageCount         Int          @default(0)
  perCustomerLimit   Int?         @default(1)
  validFrom          DateTime     @default(now())
  validUntil         DateTime?
  isActive           Boolean      @default(true)
  applicableServices String[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  createdById        String?
  bookings           Booking[]
  User               User?        @relation(fields: [createdById], references: [id])

  @@index([code])
  @@index([createdById])
  @@index([isActive])
  @@index([validFrom, validUntil])
}

model User {
  id                             String                 @id @default(cuid())
  name                           String?
  email                          String?                @unique
  emailVerified                  DateTime?
  image                          String?
  role                           Role                   @default(PARTNER)
  createdAt                      DateTime               @default(now())
  updatedAt                      DateTime               @updatedAt
  onboardedAt                    DateTime?
  password                       String?
  customer_preferences           Json?
  notary_availability            Json?
  marketing_consent              Boolean?               @default(false)
  sms_consent                    Boolean?               @default(false)
  push_notification_token        String?                @db.VarChar(500)
  accounts                       Account[]
  Assignment                     Assignment[]
  AssignmentDocument             AssignmentDocument[]
  Booking_Booking_notaryIdToUser Booking[]              @relation("Booking_notaryIdToUser")
  Booking_Booking_signerIdToUser Booking[]              @relation("Booking_signerIdToUser")
  BusinessSettings               BusinessSettings[]
  Comment                        Comment[]
  DownloadLog                    DownloadLog[]
  InvitationToken                InvitationToken[]
  NotarizationDocument           NotarizationDocument[]
  PricingAuditLog                PricingAuditLog[]
  PromoCode                      PromoCode[]
  sessions                       Session[]
  StatusHistory                  StatusHistory[]
  SystemLog                      SystemLog[]
  feature_flags                  feature_flags[]
  notary_journal                 notary_journal[]
  notary_profiles                notary_profiles?
  dispatchAssignmentsAsNotary    DispatchAssignment[]     @relation("DispatchNotary")
  dispatchAssignmentsCreated     DispatchAssignment[]     @relation("DispatchAssignedBy")
  contractorPayouts              ContractorPayout[]
  qaReviews                      BookingQARecord[]
  twoFactor                      UserTwoFactor?
  notaryApplications             NotaryApplication[]
  notaryApplicationsReviewedBy   NotaryApplication[]      @relation("NotaryApplicationReviewedBy")
  jobOffers                      JobOffer[]               @relation("JobOfferNotary")
}

model UserTwoFactor {
  userId      String    @id
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  secret      String
  backupCodes String
  isEnabled   Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([isEnabled])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}





model BusinessRulesConfig {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rule_type       String          @unique @db.VarChar(50)
  config          Json
  is_active       Boolean         @default(true)
  created_by      String?         @db.Uuid
  created_at      DateTime        @default(now())
  updated_at      DateTime        @default(now())
  rule_change_log RuleChangeLog[]

  @@index([is_active], map: "business_rules_config_active_idx")
  @@map("business_rules_config")
}

model RuleChangeLog {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rule_id               String              @db.Uuid
  old_config            Json?
  new_config            Json
  change_reason         String?
  changed_by            String?             @db.Uuid
  changed_at            DateTime            @default(now())
  business_rules_config BusinessRulesConfig @relation(fields: [rule_id], references: [id], onDelete: Cascade)

  @@index([rule_id])
  @@map("rule_change_log")
}



model BusinessSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  dataType    String   @default("string")
  description String?
  category    String?
  updatedAt   DateTime @updatedAt
  updatedById String?
  User        User?    @relation(fields: [updatedById], references: [id])

  @@index([category])
  @@index([key])
  @@index([updatedById])
}

model Assignment {
  id                   String               @id
  reference            String?              @unique
  title                String
  status               AssignmentStatus     @default(REQUESTED)
  partnerAssignedToId  String?
  propertyAddress      String?
  borrowerName         String?
  closingDate          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  allowPartnerComments Boolean              @default(false)
  User                 User?                @relation(fields: [partnerAssignedToId], references: [id])
  AssignmentDocument   AssignmentDocument[]
  Comment              Comment[]
  StatusHistory        StatusHistory[]
}

model AssignmentDocument {
  id                   String                 @id
  assignmentId         String
  key                  String
  filename             String
  uploadedAt           DateTime               @default(now())
  uploadedById         String?
  Assignment           Assignment             @relation(fields: [assignmentId], references: [id])
  User                 User?                  @relation(fields: [uploadedById], references: [id])
  DownloadLog          DownloadLog[]
  NotarizationDocument NotarizationDocument[]
}

model BackgroundError {
  id        String   @id
  source    String
  message   String
  stack     String?
  createdAt DateTime @default(now())
}

model Comment {
  id           String     @id
  text         String
  createdAt    DateTime   @default(now())
  assignmentId String
  authorId     String
  Assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  User         User       @relation(fields: [authorId], references: [id])

  @@index([assignmentId])
}

model DownloadLog {
  id                 String             @id
  documentId         String
  userId             String
  downloadedAt       DateTime           @default(now())
  AssignmentDocument AssignmentDocument @relation(fields: [documentId], references: [id])
  User               User               @relation(fields: [userId], references: [id])
}

model InvitationToken {
  id        String   @id
  token     String   @unique
  email     String
  userId    String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([userId])
}

model NotarizationDocument {
  id                         String              @id
  s3Key                      String
  originalFilename           String
  uploadedAt                 DateTime            @default(now())
  uploadedById               String
  isSigned                   Boolean             @default(false)
  signedS3Key                String?
  signedAt                   DateTime?
  createdAt                  DateTime            @default(now())
  updatedAt                  DateTime
  sourceAssignmentDocumentId String?
  bookingId                  String
  Booking                    Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  AssignmentDocument         AssignmentDocument? @relation(fields: [sourceAssignmentDocumentId], references: [id])
  User                       User                @relation(fields: [uploadedById], references: [id])

  @@index([bookingId])
  @@index([sourceAssignmentDocumentId])
  @@index([uploadedById])
}

model NotificationLog {
  id               String             @id
  bookingId        String
  notificationType NotificationType
  method           NotificationMethod
  recipientEmail   String?
  recipientPhone   String?
  subject          String?
  message          String
  sentAt           DateTime           @default(now())
  status           NotificationStatus @default(SENT)
  errorMessage     String?
  metadata         Json?
  createdAt        DateTime           @default(now())
  Booking          Booking            @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([method])
  @@index([notificationType])
  @@index([recipientEmail])
  @@index([sentAt])
}

model PricingAuditLog {
  id                String   @id
  bookingId         String?
  serviceType       String
  calculationInputs Json
  pricingResult     Json
  distanceData      Json?
  version           String   @default("2.0.0") @db.VarChar(10)
  calculatedAt      DateTime @default(now())
  requestId         String?
  userId            String?
  Booking           Booking? @relation(fields: [bookingId], references: [id])
  User              User?    @relation(fields: [userId], references: [id])

  @@index([bookingId])
  @@index([calculatedAt])
  @@index([requestId])
  @@index([serviceType])
}

model ServiceAreaCache {
  id                   String   @id
  addressHash          String   @unique @db.VarChar(64)
  originalAddress      String
  normalizedAddress    String
  distanceMiles        Float    @db.Real
  durationMinutes      Int
  isWithinStandardArea Boolean
  isWithinExtendedArea Boolean
  travelFeeStandard    Decimal  @db.Decimal(10, 2)
  travelFeeExtended    Decimal  @db.Decimal(10, 2)
  apiSource            String   @default("google_maps") @db.VarChar(20)
  calculatedAt         DateTime @default(now())
  expiresAt            DateTime
  hitCount             Int      @default(1)
  lastAccessedAt       DateTime @default(now())

  @@index([addressHash])
  @@index([distanceMiles])
  @@index([expiresAt])
  @@index([lastAccessedAt])
}

model StatusHistory {
  id           String           @id
  assignmentId String
  status       AssignmentStatus
  note         String?
  changedAt    DateTime         @default(now())
  changedById  String?
  Assignment   Assignment       @relation(fields: [assignmentId], references: [id])
  User         User?            @relation(fields: [changedById], references: [id])
}

model SystemAlert {
  id         String        @id
  component  String
  message    String
  severity   AlertSeverity @default(MEDIUM)
  status     AlertStatus   @default(ACTIVE)
  createdAt  DateTime      @default(now())
  resolvedAt DateTime?
  resolvedBy String?
  detail     Json?

  @@index([createdAt])
  @@index([severity])
  @@index([status])
}

model SystemLog {
  id        String   @id
  component String
  message   String
  level     LogLevel @default(INFO)
  timestamp DateTime @default(now())
  metadata  Json?
  userId    String?
  User      User?    @relation(fields: [userId], references: [id])

  @@index([component])
  @@index([level])
  @@index([timestamp])
}

model AuditLog {
  id          String   @id @default(cuid())
  bookingId   String?
  entity      String
  action      String
  performedBy String?
  timestamp   DateTime @default(now())
  data        Json?
  prevHash    String?
  hash        String
  Booking     Booking? @relation(fields: [bookingId], references: [id])

  @@index([bookingId, timestamp])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model daily_metrics {
  date                  DateTime  @id @db.Date
  total_bookings        Int?      @default(0)
  mobile_bookings       Int?      @default(0)
  ron_bookings          Int?      @default(0)
  completed_bookings    Int?      @default(0)
  cancelled_bookings    Int?      @default(0)
  total_revenue         Decimal?  @default(0) @db.Decimal(10, 2)
  mobile_revenue        Decimal?  @default(0) @db.Decimal(10, 2)
  ron_revenue           Decimal?  @default(0) @db.Decimal(10, 2)
  proof_costs           Decimal?  @default(0) @db.Decimal(10, 2)
  mileage_costs         Decimal?  @default(0) @db.Decimal(10, 2)
  stripe_fees           Decimal?  @default(0) @db.Decimal(10, 2)
  net_revenue           Decimal?  @default(0) @db.Decimal(10, 2)
  margin_percentage     Decimal?  @db.Decimal(5, 2)
  average_booking_value Decimal?  @db.Decimal(10, 2)
  conversion_rate       Decimal?  @db.Decimal(5, 2)
  customer_satisfaction Decimal?  @db.Decimal(3, 2)
  new_customers         Int?      @default(0)
  repeat_customers      Int?      @default(0)
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  updated_at            DateTime? @default(now()) @db.Timestamptz(6)

  @@index([date], map: "idx_daily_metrics_date")
}

model GMBActivity {
  id              String    @id @default(cuid())
  type            String    // 'SERVICE_COMPLETION', 'REVIEW_THANK_YOU', 'PROMOTIONAL_POST', etc.
  status          String    @default("SUCCESS") // 'SUCCESS', 'FAILED', 'PENDING'
  data            Json?     // Store the post data/metadata
  gmbPostId       String?   // ID returned from GMB API
  bookingId       String?   // Reference to booking if applicable
  reviewId        String?   // Reference to review if applicable
  ghlContactId    String?   // Reference to GHL contact if applicable
  engagement      Json?     // Store engagement metrics when available
  errorMessage    String?   // Store error details if failed
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)

  @@index([type], map: "idx_gmb_activity_type")
  @@index([status], map: "idx_gmb_activity_status")
  @@index([createdAt], map: "idx_gmb_activity_created_at")
  @@index([bookingId], map: "idx_gmb_activity_booking_id")
  @@index([ghlContactId], map: "idx_gmb_activity_ghl_contact_id")
  @@map("gmb_activity")
}

model Review {
  id                String    @id @default(cuid())
  reviewerName      String    @db.VarChar(200)
  reviewerEmail     String?   @db.VarChar(255)
  rating            Int       @db.SmallInt // 1-5 stars
  reviewText        String    @db.Text
  serviceType       String?   @db.VarChar(100)
  platform          String?   @db.VarChar(50) // 'google', 'internal', 'yelp', 'facebook'
  externalId        String?   @unique @db.VarChar(255) // ID from external platform
  externalUrl       String?   @db.VarChar(500) // URL to review on external platform
  bookingId         String?   // Reference to booking if from customer
  ghlContactId      String?   @db.VarChar(100) // Reference to GHL contact
  isVerified        Boolean   @default(false) // Verified purchase/service
  isApproved        Boolean   @default(true) // Admin approval status
  isFeatured        Boolean   @default(false) // Featured on website
  helpfulCount      Int       @default(0) // Number of helpful votes
  responseText      String?   @db.Text // Business response to review
  responseDate      DateTime? @db.Timestamptz(6)
  metadata          Json?     // Additional platform-specific data
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @db.Timestamptz(6)
  
  // Relations
  booking           Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([rating], map: "idx_reviews_rating")
  @@index([platform], map: "idx_reviews_platform") 
  @@index([isApproved], map: "idx_reviews_approved")
  @@index([isFeatured], map: "idx_reviews_featured")
  @@index([createdAt], map: "idx_reviews_created_at")
  @@index([bookingId], map: "idx_reviews_booking_id")
  @@index([ghlContactId], map: "idx_reviews_ghl_contact")
  @@map("reviews")
}

// Phase 5: Local SEO - Citation Management Models
model Citation {
  id                String   @id @default(cuid())
  platform          String   // 'Google My Business', 'Yelp', 'Facebook', etc.
  business_name     String
  phone             String?
  website           String?
  address_street    String?
  address_city      String?
  address_state     String?
  address_zip       String?
  address_formatted String?
  business_hours    Json?    // Store hours as JSON object
  categories        String[] // Array of business categories
  rating            Float?   // Average rating
  review_count      Int?     // Number of reviews
  photos            String[] // Array of photo URLs
  description       String?  @db.Text
  verified          Boolean  @default(false)
  claimed           Boolean  @default(false)
  url               String   // Direct URL to the listing
  last_updated      DateTime @default(now())
  discovered_at     DateTime @default(now())
  status            String   @default("active") // 'active', 'inactive', 'pending', 'error'
  nap_consistency   Int      @default(0) // 0-100 consistency score
  
  // SEO tracking
  domain_authority  Int?     // Domain authority of the platform
  platform_category String?  // 'major', 'local', 'niche', 'social'
  importance        String?  // 'high', 'medium', 'low'
  
  // Management tracking
  submission_method String?  // 'api', 'manual', 'bulk'
  managed_by        String?  // User ID who manages this citation
  notes             String?  @db.Text
  
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  // Relations
  audit_logs        CitationAudit[]
  
  @@map("citations")
  @@index([platform])
  @@index([nap_consistency])
  @@index([status])
}

model CitationAudit {
  id                String   @id @default(cuid())
  citation_id       String
  audit_type        String   // 'discovery', 'consistency_check', 'update', 'verification'
  previous_data     Json?    // Previous citation data
  current_data      Json?    // Current citation data
  consistency_score Int      // 0-100 score
  inconsistencies   Json?    // Array of inconsistency objects
  recommendations   String[] // Array of recommendation strings
  audit_date        DateTime @default(now())
  audited_by        String?  // User ID or 'system'
  
  // Relations
  citation          Citation @relation(fields: [citation_id], references: [id], onDelete: Cascade)
  
  @@map("citation_audits")
  @@index([citation_id])
  @@index([audit_date])
}

model DirectorySubmission {
  id                String   @id @default(cuid())
  directory_name    String
  directory_url     String
  submission_status String   @default("pending") // 'pending', 'submitted', 'approved', 'rejected', 'error'
  submission_date   DateTime @default(now())
  approval_date     DateTime?
  business_data     Json     // Business data submitted
  submission_method String   // 'api', 'manual', 'bulk'
  tracking_id       String?  // External tracking ID
  notes             String?  @db.Text
  
  // Performance tracking
  clicks            Int      @default(0)
  views             Int      @default(0)
  conversions       Int      @default(0)
  
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@map("directory_submissions")
  @@index([submission_status])
  @@index([submission_date])
}

model LocalSEOMetrics {
  id                    String   @id @default(cuid())
  date                  DateTime @db.Date
  
  // Citation metrics
  total_citations       Int      @default(0)
  verified_citations    Int      @default(0)
  claimed_citations     Int      @default(0)
  consistent_citations  Int      @default(0)
  avg_consistency_score Float    @default(0)
  
  // Platform distribution
  google_citations      Int      @default(0)
  yelp_citations        Int      @default(0)
  facebook_citations    Int      @default(0)
  local_citations       Int      @default(0)
  niche_citations       Int      @default(0)
  
  // Review metrics
  total_reviews         Int      @default(0)
  avg_rating            Float    @default(0)
  new_reviews           Int      @default(0)
  
  // Local search performance
  local_search_clicks   Int      @default(0)
  local_search_views    Int      @default(0)
  local_ctr             Float    @default(0)
  
  // Directory performance
  directory_submissions Int      @default(0)
  approved_submissions  Int      @default(0)
  pending_submissions   Int      @default(0)
  
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
  
  @@map("local_seo_metrics")
  @@unique([date])
  @@index([date])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model feature_flags {
  key                String    @id @db.VarChar(100)
  enabled            Boolean?  @default(false)
  description        String?
  rollout_percentage Int?      @default(0)
  target_roles       String[]
  target_users       String[]
  environment        String?   @default("development") @db.VarChar(20)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @default(now()) @db.Timestamptz(6)
  created_by         String?
  User               User?     @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([environment], map: "idx_feature_flags_environment")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model mileage_cache {
  id                   String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  origin_address       String?   @db.VarChar(500)
  destination_address  String?   @db.VarChar(500)
  distance_miles       Decimal?  @db.Decimal(5, 2)
  duration_minutes     Int?
  google_maps_response Json?
  last_calculated      DateTime? @default(now()) @db.Timestamptz(6)
  hit_count            Int?      @default(1)

  @@unique([origin_address, destination_address])
  @@index([origin_address, destination_address], map: "idx_mileage_cache_addresses")
  @@index([last_calculated], map: "idx_mileage_cache_calculated")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model notary_journal {
  id                String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  booking_id        String?
  notary_id         String
  entry_date        DateTime  @db.Date
  journal_number    Int?
  document_type     String?   @db.VarChar(100)
  signer_name       String?   @db.VarChar(200)
  signer_id_type    String?   @db.VarChar(50)
  signer_id_state   String?   @db.VarChar(2)
  notarial_act_type String?   @db.VarChar(50)
  fee_charged       Decimal?  @db.Decimal(10, 2)
  location          String?
  additional_notes  String?
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  Booking           Booking?  @relation(fields: [booking_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User              User      @relation(fields: [notary_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([notary_id, journal_number])
  @@index([booking_id], map: "idx_notary_journal_booking_id")
  @@index([notary_id, entry_date], map: "idx_notary_journal_notary_date")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model notary_profiles {
  id                      String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id                 String    @unique
  commission_number       String?   @db.VarChar(50)
  commission_expiry       DateTime? @db.Date
  base_address            String?
  base_zip                String?   @db.VarChar(10)
  service_radius_miles    Int?      @default(25)
  is_active               Boolean?  @default(true)
  emergency_contact       String?   @db.VarChar(20)
  preferred_service_types String[]
  preferred_zip_codes     String[]  @default([])
  preferred_start_hour    Int?      @default(8)
  preferred_end_hour      Int?      @default(20)
  daily_capacity          Int?      @default(8)
  created_at              DateTime? @default(now()) @db.Timestamptz(6)
  updated_at              DateTime? @default(now()) @db.Timestamptz(6)
  // Enhanced fields for network notaries
  onboarding_status       NotaryOnboardingStatus @default(PENDING)
  eo_insurance_provider   String?   @db.VarChar(200)
  eo_insurance_policy     String?   @db.VarChar(100)
  eo_insurance_expiry     DateTime? @db.Date
  eo_insurance_document_url String? @db.Text
  background_check_status BackgroundCheckStatus @default(PENDING)
  background_check_date   DateTime? @db.Date
  background_check_document_url String? @db.Text
  w9_on_file              Boolean?  @default(false)
  w9_document_url         String?   @db.Text
  states_licensed          String[]  @default([])
  counties_served          String[]  @default([])
  languages_spoken        String[]  @default([])
  years_experience         Int?
  special_certifications  String[]  @default([])
  availability_status      NotaryAvailabilityStatus @default(AVAILABLE)
  User                    User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([is_active], map: "idx_notary_profiles_active")
  @@index([user_id], map: "idx_notary_profiles_user_id")
  @@index([onboarding_status], map: "idx_notary_profiles_onboarding")
  @@index([availability_status], map: "idx_notary_profiles_availability")
}

model DispatchAssignment {
  id           String   @id @default(cuid())
  bookingId    String
  notaryId     String
  assignedById String?
  assignedAt   DateTime @default(now())
  score        Float?
  notes        String?

  Booking    Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  Notary     User    @relation("DispatchNotary", fields: [notaryId], references: [id])
  assignedBy User?   @relation("DispatchAssignedBy", fields: [assignedById], references: [id])

  @@index([bookingId])
  @@index([notaryId])
  @@index([assignedAt])
}

model NotaryApplication {
  id                    String                    @id @default(cuid())
  firstName             String
  lastName              String
  email                 String                    @unique
  phone                 String
  commissionNumber     String?
  commissionState      String?
  commissionExpiry      DateTime?                 @db.Date
  statesLicensed        String[]
  countiesServed        String[]
  yearsExperience       Int?
  serviceTypes          String[]
  languagesSpoken       String[]
  specialCertifications String[]
  eoInsuranceProvider    String?
  eoInsurancePolicy     String?
  eoInsuranceExpiry     DateTime?                 @db.Date
  baseAddress           String?
  baseZip               String?
  serviceRadiusMiles   Int?                      @default(25)
  availabilityNotes     String?                   @db.Text
  whyInterested         String?                  @db.Text
  references            String?                  @db.Text
  resumeUrl             String?                  @db.Text
  status                NotaryApplicationStatus  @default(PENDING)
  reviewedById           String?
  reviewedAt            DateTime?
  reviewNotes           String?                  @db.Text
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  // If approved and converted to User account
  convertedToUserId     String?                 @unique
  convertedAt           DateTime?

  reviewedBy            User?                    @relation("NotaryApplicationReviewedBy", fields: [reviewedById], references: [id])
  convertedToUser       User?                    @relation(fields: [convertedToUserId], references: [id])

  @@index([status], map: "idx_notary_application_status")
  @@index([email], map: "idx_notary_application_email")
  @@index([createdAt], map: "idx_notary_application_created")
}

model JobOffer {
  id                    String          @id @default(cuid())
  bookingId             String
  notaryId              String
  status                JobOfferStatus  @default(PENDING)
  expiresAt             DateTime
  notifiedAt            DateTime?
  acceptedAt            DateTime?
  declinedAt            DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  notes                 String?         @db.Text

  Booking               Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  Notary                User            @relation("JobOfferNotary", fields: [notaryId], references: [id])

  @@index([bookingId], map: "idx_job_offer_booking")
  @@index([notaryId], map: "idx_job_offer_notary")
  @@index([status], map: "idx_job_offer_status")
  @@index([expiresAt], map: "idx_job_offer_expires")
  @@unique([bookingId, notaryId], map: "unique_booking_notary_offer")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model service_areas {
  id                     String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  name                   String    @unique @db.VarChar(100)
  description            String?
  polygon_coordinates    Json?
  service_fee_multiplier Decimal?  @default(1.0) @db.Decimal(3, 2)
  active                 Boolean?  @default(true)
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)
  Booking                Booking[]

  @@index([active], map: "idx_service_areas_active")
}

enum ServiceType {
  STANDARD_NOTARY
  EXTENDED_HOURS
  LOAN_SIGNING
  RON_SERVICES
  BUSINESS_ESSENTIALS
  BUSINESS_GROWTH
  ESTATE_PLANNING
  SPECIALTY_NOTARY
  BUSINESS_SOLUTIONS
}

enum LocationType {
  CLIENT_SPECIFIED_ADDRESS
  OUR_OFFICE
  REMOTE_ONLINE_NOTARIZATION
  PUBLIC_PLACE
}

enum BookingStatus {
  REQUESTED
  PAYMENT_PENDING
  CONFIRMED
  SCHEDULED
  AWAITING_CLIENT_ACTION
  READY_FOR_SERVICE
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_CLIENT
  CANCELLED_BY_STAFF
  REQUIRES_RESCHEDULE
  ARCHIVED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  VOIDED
}

enum PaymentProvider {
  STRIPE
  SQUARE
  PAYPAL
  MANUAL
  OTHER
}

enum PaymentMethod {
  PAY_ON_SITE
  CARD
  ACH
  OTHER
}

enum ContractorPayoutStatus {
  PENDING
  APPROVED
  PAID
}

enum ContractorPayoutEntryType {
  BASE
  TRAVEL_SHARE
  URGENCY_BONUS
  WITNESS_SPLIT
  ADJUSTMENT
}

enum QAStatus {
  PENDING
  IN_PROGRESS
  FLAGGED
  COMPLETE
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum NotificationType {
  BOOKING_CONFIRMATION
  PAYMENT_CONFIRMATION
  APPOINTMENT_REMINDER_24HR
  APPOINTMENT_REMINDER_2HR
  APPOINTMENT_REMINDER_1HR
  APPOINTMENT_REMINDER_NOW
  BOOKING_CANCELLED
  BOOKING_RESCHEDULED
  PAYMENT_FAILED
  PAYMENT_REMINDER
  NO_SHOW_CHECK
  POST_SERVICE_FOLLOWUP
  REVIEW_REQUEST
  DOCUMENT_READY
  DOCUMENT_REMINDER
  NOTARY_ASSIGNMENT
  EMERGENCY_NOTIFICATION
  LEAD_NURTURING
  PAYMENT_UPDATE
}

enum NotificationMethod {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  UNSUBSCRIBED
}

enum Role {
  ADMIN
  STAFF
  PARTNER
  SIGNER
  NOTARY
}

enum SupportIssueType {
  booking_question
  payment_issue
  reschedule_request
  cancellation_request
  service_issue
  technical_support
  billing_inquiry
  general_inquiry
  complaint
  feedback
}

enum SupportPriority {
  low
  medium
  high
  urgent
}

enum SupportStatus {
  open
  in_progress
  waiting_customer
  resolved
  closed
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AlertStatus {
  ACTIVE
  RESOLVED
  ACKNOWLEDGED
}

enum AssignmentStatus {
  REQUESTED
  SCHEDULED
  IN_PROGRESS
  SIGNED
  RETURNED_TO_TITLE
  COMPLETED
  ARCHIVED
}

enum LogLevel {
  ERROR
  WARN
  INFO
  DEBUG
}

enum witness_source {
  customer_provided
  staff_provided
  proof_provided
}

enum NotaryApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  CONVERTED
}

enum NotaryOnboardingStatus {
  PENDING
  IN_PROGRESS
  DOCUMENTS_PENDING
  COMPLETE
  SUSPENDED
}

enum BackgroundCheckStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  EXPIRED
}

enum NotaryAvailabilityStatus {
  AVAILABLE
  BUSY
  UNAVAILABLE
  ON_LEAVE
}

enum JobOfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}
