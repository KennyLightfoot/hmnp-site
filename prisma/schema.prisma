generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Assignment {
  id                   String               @id
  reference            String?              @unique
  title                String
  status               AssignmentStatus     @default(REQUESTED)
  partnerAssignedToId  String?
  propertyAddress      String?
  borrowerName         String?
  closingDate          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  allowPartnerComments Boolean              @default(false)
  User                 User?                @relation(fields: [partnerAssignedToId], references: [id])
  AssignmentDocument   AssignmentDocument[]
  Comment              Comment[]
  StatusHistory        StatusHistory[]
}

model AssignmentDocument {
  id           String        @id
  assignmentId String
  key          String
  filename     String
  uploadedAt   DateTime      @default(now())
  uploadedById String?
  Assignment   Assignment    @relation(fields: [assignmentId], references: [id])
  User         User?         @relation(fields: [uploadedById], references: [id])
  DownloadLog  DownloadLog[]
}

model BackgroundError {
  id        String   @id
  source    String
  message   String
  stack     String?
  createdAt DateTime @default(now())
}

model Booking {
  id                          String          @id
  signerId                    String?
  serviceId                   String
  notaryId                    String?
  scheduledDateTime           DateTime?
  actualEndDateTime           DateTime?
  status                      BookingStatus   @default(REQUESTED)
  locationType                LocationType?
  addressStreet               String?
  addressCity                 String?
  addressState                String?
  addressZip                  String?
  locationNotes               String?
  priceAtBooking              Decimal         @db.Decimal(10, 2)
  notes                       String?
  dailyRoomUrl                String?
  dailyRecordingId            String?
  kbaStatus                   String?
  idVerificationStatus        String?
  notaryJournalEntry          String?
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime
  confirmationEmailSentAt     DateTime?
  confirmationSmsSentAt       DateTime?
  followUpSentAt              DateTime?
  lastReminderSentAt          DateTime?
  noShowCheckPerformedAt      DateTime?
  reminder1hrSentAt           DateTime?
  reminder24hrSentAt          DateTime?
  reminder2hrSentAt           DateTime?
  depositAmount               Decimal?        @db.Decimal(10, 2)
  depositStatus               PaymentStatus?  @default(PENDING)
  googleCalendarEventId       String?
  promoCodeDiscount           Decimal?        @db.Decimal(10, 2)
  promoCodeId                 String?
  campaignName                String?
  customerEmail               String?
  ghlContactId                String?
  leadSource                  String?
  stripePaymentUrl            String?
  workflowId                  String?
  witnessType                 witness_source? @map("witness_type")
  witnessFee                  Decimal?        @default(0) @map("witness_fee") @db.Decimal(5, 2)
  mileageMiles                Decimal?        @map("mileage_miles") @db.Decimal(5, 2)
  mileageFee                  Decimal?        @default(0) @map("mileage_fee") @db.Decimal(5, 2)
  urgencyLevel                String?         @default("standard") @map("urgency_level") @db.VarChar(20)
  urgencyFee                  Decimal?        @default(0) @map("urgency_fee") @db.Decimal(5, 2)
  estimatedCompletionTime     DateTime?       @map("estimated_completion_time") @db.Timestamptz(6)
  notaryTravelTimeMinutes     Int?            @map("notary_travel_time_minutes")
  googleMapsDistanceMatrix    Json?           @map("google_maps_distance_matrix")
  serviceAreaId               String?         @map("service_area_id")
  User_Booking_notaryIdToUser User?           @relation("Booking_notaryIdToUser", fields: [notaryId], references: [id])
  PromoCode                   PromoCode?      @relation(fields: [promoCodeId], references: [id])
  Service                     Service         @relation(fields: [serviceId], references: [id])
  User_Booking_signerIdToUser User?           @relation("Booking_signerIdToUser", fields: [signerId], references: [id])

  @@index([notaryId])
  @@index([scheduledDateTime])
  @@index([serviceId])
  @@index([signerId])
  @@index([status])
  @@index([serviceAreaId], map: "idx_booking_service_area")
  @@index([urgencyLevel], map: "idx_booking_urgency")
}

model BusinessSettings {
  id          String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  key         String   @unique
  value       String
  dataType    String   @default("string")
  description String?
  category    String?
  updatedAt   DateTime @updatedAt
  updatedById String?
  User        User?    @relation(fields: [updatedById], references: [id])

  @@index([category])
  @@index([key])
  @@index([updatedById])
}

model Comment {
  id           String     @id
  text         String
  createdAt    DateTime   @default(now())
  assignmentId String
  authorId     String
  Assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  User         User       @relation(fields: [authorId], references: [id])

  @@index([assignmentId])
}

model DownloadLog {
  id                 String             @id
  documentId         String
  userId             String
  downloadedAt       DateTime           @default(now())
  AssignmentDocument AssignmentDocument @relation(fields: [documentId], references: [id])
  User               User               @relation(fields: [userId], references: [id])
}

model InvitationToken {
  id        String   @id
  token     String   @unique
  email     String
  userId    String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([email])
}

model NotarizationDocument {
  id                         String    @id
  s3Key                      String
  originalFilename           String
  uploadedAt                 DateTime  @default(now())
  uploadedById               String
  isSigned                   Boolean   @default(false)
  signedS3Key                String?
  signedAt                   DateTime?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime
  sourceAssignmentDocumentId String?
  bookingId                  String
}

model NotificationLog {
  id               String             @id
  bookingId        String
  notificationType NotificationType
  method           NotificationMethod
  recipientEmail   String?
  recipientPhone   String?
  subject          String?
  message          String
  sentAt           DateTime           @default(now())
  status           NotificationStatus @default(SENT)
  errorMessage     String?
  metadata         Json?
  createdAt        DateTime           @default(now())

  @@index([bookingId])
}

model Payment {
  id              String          @id
  bookingId       String
  amount          Decimal         @db.Decimal(10, 2)
  status          PaymentStatus   @default(PENDING)
  provider        PaymentProvider
  transactionId   String?
  paymentIntentId String?
  notes           String?
  paidAt          DateTime?
  refundedAmount  Decimal?        @db.Decimal(10, 2)
  refundedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  metadata        Json?
  currency        String?         @default("USD")
  completedAt     DateTime?

  @@index([bookingId])
  @@index([provider])
  @@index([status])
}

model PromoCode {
  id                 String       @id
  code               String       @unique
  description        String?
  discountType       DiscountType @default(PERCENTAGE)
  discountValue      Decimal      @db.Decimal(10, 2)
  minimumAmount      Decimal?     @db.Decimal(10, 2)
  maxDiscountAmount  Decimal?     @db.Decimal(10, 2)
  usageLimit         Int?
  usageCount         Int          @default(0)
  perCustomerLimit   Int?         @default(1)
  validFrom          DateTime     @default(now())
  validUntil         DateTime?
  isActive           Boolean      @default(true)
  applicableServices String[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime
  createdById        String?
  Booking            Booking[]
  User               User?        @relation(fields: [createdById], references: [id])

  @@index([code])
  @@index([createdById])
  @@index([validFrom, validUntil])
}

model Service {
  id                 String      @id
  name               String      @unique
  description        String?
  serviceType        ServiceType
  durationMinutes    Int
  basePrice          Decimal     @db.Decimal(10, 2)
  isActive           Boolean     @default(true)
  requiresDeposit    Boolean     @default(true)
  depositAmount      Decimal     @default(25.00) @db.Decimal(10, 2)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime
  externalCalendarId String?     @unique
  Booking            Booking[]

  @@index([serviceType])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StatusHistory {
  id           String           @id
  assignmentId String
  status       AssignmentStatus
  note         String?
  changedAt    DateTime         @default(now())
  changedById  String?
  Assignment   Assignment       @relation(fields: [assignmentId], references: [id])
  User         User?            @relation(fields: [changedById], references: [id])
}

model SystemAlert {
  id         String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  component  String
  message    String
  severity   AlertSeverity @default(MEDIUM)
  status     AlertStatus   @default(ACTIVE)
  createdAt  DateTime      @default(now())
  resolvedAt DateTime?
  resolvedBy String?
  detail     Json?

  @@index([createdAt])
  @@index([severity])
  @@index([status])
}

model SystemLog {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  component String
  message   String
  level     LogLevel @default(INFO)
  timestamp DateTime @default(now())
  metadata  Json?
  userId    String?
  User      User?    @relation(fields: [userId], references: [id])

  @@index([component])
  @@index([level])
  @@index([timestamp])
}

model User {
  id                             String               @id
  name                           String?
  email                          String?              @unique
  emailVerified                  DateTime?
  image                          String?
  role                           Role                 @default(PARTNER)
  createdAt                      DateTime             @default(now())
  updatedAt                      DateTime
  onboardedAt                    DateTime?
  password                       String?
  customerPreferences            Json?                @map("customer_preferences")
  notaryAvailability             Json?                @map("notary_availability")
  marketingConsent               Boolean?             @default(false) @map("marketing_consent")
  smsConsent                     Boolean?             @default(false) @map("sms_consent")
  pushNotificationToken          String?              @map("push_notification_token") @db.VarChar(500)
  Account                        Account[]
  Assignment                     Assignment[]
  AssignmentDocument             AssignmentDocument[]
  Booking_Booking_notaryIdToUser Booking[]            @relation("Booking_notaryIdToUser")
  Booking_Booking_signerIdToUser Booking[]            @relation("Booking_signerIdToUser")
  BusinessSettings               BusinessSettings[]
  Comment                        Comment[]
  DownloadLog                    DownloadLog[]
  PromoCode                      PromoCode[]
  Session                        Session[]
  StatusHistory                  StatusHistory[]
  SystemLog                      SystemLog[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model NotaryProfile {
  id                    String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id               String    @unique
  commissionNumber      String?   @map("commission_number") @db.VarChar(50)
  commissionExpiry      DateTime? @map("commission_expiry") @db.Date
  baseAddress           String?   @map("base_address")
  serviceRadiusMiles    Int?      @default(25) @map("service_radius_miles")
  isActive              Boolean?  @default(true) @map("is_active")
  emergencyContact      String?   @map("emergency_contact") @db.VarChar(20)
  preferredServiceTypes String[]  @map("preferred_service_types")
  dailyCapacity         Int?      @default(8) @map("daily_capacity")
  createdAt             DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("notary_profiles")
}

model NotaryJournal {
  id              String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  bookingId       String?   @map("booking_id")
  notaryId        String    @map("notary_id")
  entryDate       DateTime  @map("entry_date") @db.Date
  journalNumber   Int?      @map("journal_number")
  documentType    String?   @map("document_type") @db.VarChar(100)
  signerName      String?   @map("signer_name") @db.VarChar(200)
  signerIdType    String?   @map("signer_id_type") @db.VarChar(50)
  signerIdState   String?   @map("signer_id_state") @db.VarChar(2)
  notarialActType String?   @map("notarial_act_type") @db.VarChar(50)
  feeCharged      Decimal?  @map("fee_charged") @db.Decimal(10, 2)
  location        String?
  additionalNotes String?   @map("additional_notes")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([notaryId, journalNumber])
  @@index([bookingId], map: "idx_notary_journal_booking_id")
  @@index([notaryId, entryDate], map: "idx_notary_journal_notary_date")
  @@map("notary_journal")
}

model ServiceArea {
  id                   String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  name                 String    @unique @db.VarChar(100)
  description          String?
  polygonCoordinates   Json?     @map("polygon_coordinates")
  serviceFeeMultiplier Decimal?  @default(1.0) @map("service_fee_multiplier") @db.Decimal(3, 2)
  active               Boolean?  @default(true)
  createdAt            DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([active], map: "idx_service_areas_active")
  @@map("service_areas")
}

model MileageCache {
  id                 String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  originAddress      String?   @map("origin_address") @db.VarChar(500)
  destinationAddress String?   @map("destination_address") @db.VarChar(500)
  distanceMiles      Decimal?  @map("distance_miles") @db.Decimal(5, 2)
  durationMinutes    Int?      @map("duration_minutes")
  googleMapsResponse Json?     @map("google_maps_response")
  lastCalculated     DateTime? @default(now()) @map("last_calculated") @db.Timestamptz(6)
  hitCount           Int?      @default(1) @map("hit_count")

  @@unique([originAddress, destinationAddress])
  @@index([lastCalculated], map: "idx_mileage_cache_calculated")
  @@map("mileage_cache")
}

model DailyMetric {
  date                 DateTime  @id @db.Date
  totalBookings        Int?      @default(0) @map("total_bookings")
  mobileBookings       Int?      @default(0) @map("mobile_bookings")
  ronBookings          Int?      @default(0) @map("ron_bookings")
  completedBookings    Int?      @default(0) @map("completed_bookings")
  cancelledBookings    Int?      @default(0) @map("cancelled_bookings")
  totalRevenue         Decimal?  @default(0) @map("total_revenue") @db.Decimal(10, 2)
  mobileRevenue        Decimal?  @default(0) @map("mobile_revenue") @db.Decimal(10, 2)
  ronRevenue           Decimal?  @default(0) @map("ron_revenue") @db.Decimal(10, 2)
  proofCosts           Decimal?  @default(0) @map("proof_costs") @db.Decimal(10, 2)
  mileageCosts         Decimal?  @default(0) @map("mileage_costs") @db.Decimal(10, 2)
  stripeFees           Decimal?  @default(0) @map("stripe_fees") @db.Decimal(10, 2)
  netRevenue           Decimal?  @default(0) @map("net_revenue") @db.Decimal(10, 2)
  marginPercentage     Decimal?  @map("margin_percentage") @db.Decimal(5, 2)
  averageBookingValue  Decimal?  @map("average_booking_value") @db.Decimal(10, 2)
  conversionRate       Decimal?  @map("conversion_rate") @db.Decimal(5, 2)
  customerSatisfaction Decimal?  @map("customer_satisfaction") @db.Decimal(3, 2)
  newCustomers         Int?      @default(0) @map("new_customers")
  repeatCustomers      Int?      @default(0) @map("repeat_customers")
  createdAt            DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("daily_metrics")
}

model FeatureFlag {
  key               String    @id @db.VarChar(100)
  enabled           Boolean?  @default(false)
  description       String?
  rolloutPercentage Int?      @default(0) @map("rollout_percentage")
  targetRoles       String[]  @map("target_roles")
  targetUsers       String[]  @map("target_users")
  environment       String?   @default("development") @db.VarChar(20)
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy         String?   @map("created_by")

  @@index([environment], map: "idx_feature_flags_environment")
  @@map("feature_flags")
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AlertStatus {
  ACTIVE
  RESOLVED
  ACKNOWLEDGED
}

enum AssignmentStatus {
  REQUESTED
  SCHEDULED
  IN_PROGRESS
  SIGNED
  RETURNED_TO_TITLE
  COMPLETED
  ARCHIVED
}

enum BookingStatus {
  REQUESTED
  PAYMENT_PENDING
  CONFIRMED
  SCHEDULED
  AWAITING_CLIENT_ACTION
  READY_FOR_SERVICE
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_CLIENT
  CANCELLED_BY_STAFF
  REQUIRES_RESCHEDULE
  ARCHIVED
  NO_SHOW
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum LocationType {
  CLIENT_SPECIFIED_ADDRESS
  OUR_OFFICE
  REMOTE_ONLINE_NOTARIZATION
  PUBLIC_PLACE
}

enum LogLevel {
  ERROR
  WARN
  INFO
  DEBUG
}

enum NotificationMethod {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  UNSUBSCRIBED
}

enum NotificationType {
  BOOKING_CONFIRMATION
  PAYMENT_CONFIRMATION
  APPOINTMENT_REMINDER_24HR
  APPOINTMENT_REMINDER_2HR
  APPOINTMENT_REMINDER_1HR
  APPOINTMENT_REMINDER_NOW
  BOOKING_CANCELLED
  BOOKING_RESCHEDULED
  PAYMENT_FAILED
  PAYMENT_REMINDER
  NO_SHOW_CHECK
  POST_SERVICE_FOLLOWUP
  REVIEW_REQUEST
  DOCUMENT_READY
  DOCUMENT_REMINDER
  NOTARY_ASSIGNMENT
  EMERGENCY_NOTIFICATION
  LEAD_NURTURING
  PAYMENT_UPDATE
}

enum PaymentProvider {
  STRIPE
  SQUARE
  PAYPAL
  MANUAL
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  VOIDED
}

enum Role {
  ADMIN
  STAFF
  PARTNER
  SIGNER
  NOTARY
  CLIENT
}

enum ServiceType {
  STANDARD_NOTARY
  EXTENDED_HOURS_NOTARY
  LOAN_SIGNING_SPECIALIST
  SPECIALTY_NOTARY_SERVICE
  BUSINESS_SOLUTIONS
  SUPPORT_SERVICE
}

enum WitnessSource {
  CUSTOMER_PROVIDED
  STAFF_PROVIDED
  PROOF_PROVIDED
}

enum UrgencyLevel {
  STANDARD
  SAME_DAY
  EMERGENCY
}

enum witness_source {
  customer_provided
  staff_provided
  proof_provided
}
